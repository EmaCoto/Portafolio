---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const allProjects = await getCollection("projects");
const sortedProjects = allProjects.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const title = "Emanuel Cortes | Proyectos — Casos de Captación";
const description = "Explora mi portafolio de sistemas digitales. Analizo y desarrollo herramientas a medida enfocadas en convertir usuarios en clientes mediante código y SEO técnico.";
---

<Layout title={title} description={description}>
  <section class="max-w-7xl mx-auto px-4 sm:px-6 py-20 md:py-24 bg-[#0a0709]">
    
    <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-8 mb-12 md:mb-20">
      <div>
        <h1 class="text-5xl sm:text-7xl lg:text-8xl font-black text-white uppercase italic tracking-tighter leading-[0.8]">Portfolio</h1>
        <p class="text-[#72bf78] font-mono text-[10px] sm:text-sm tracking-[0.3em] uppercase mt-6">Proyectos & Aplicaciones</p>
      </div>

      <div class="flex overflow-x-auto pb-4 lg:pb-0 no-scrollbar gap-3 sm:gap-4 -mx-4 px-4 lg:mx-0 lg:px-0">
        <button class="filter-btn active whitespace-nowrap" data-filter="all">Todos</button>
        <button class="filter-btn whitespace-nowrap" data-filter="página-web">Páginas Web</button>
        <button class="filter-btn whitespace-nowrap" data-filter="aplicación-web">Apps Web</button>
        <button class="filter-btn whitespace-nowrap" data-filter="soporte-página-web">Soporte Página Web</button>
      </div>
    </div>

    <div id="projectGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-10">
      {sortedProjects.map((project) => (
        <article 
          class="project-item group relative bg-[#0d0d0d] rounded-2xl md:rounded-3xl border border-white/5 overflow-hidden flex flex-col md:flex-row transition-all hover:border-[#72bf78]/30 shadow-2xl"
          data-category={project.data.category.toLowerCase().replace(/\s+/g, '-')}
        >
          <div class="relative w-full md:w-[42%] aspect-video md:aspect-auto overflow-hidden shrink-0">
            <img 
              src={project.data.image} 
              alt={project.data.title} 
              class="w-full h-full object-cover opacity-100 md:grayscale md:opacity-40 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-700 group-hover:scale-110"
            />
            <div class="absolute inset-0 bg-linear-to-t md:bg-linear-to-r from-[#0d0d0d] via-transparent to-transparent opacity-80 md:opacity-100"></div>
          </div>

          <div class="p-6 md:p-8 flex flex-col justify-center flex-1">
            <span class="text-[#72bf78] font-mono text-[9px] tracking-widest uppercase bg-[#72bf78]/10 px-3 py-1 rounded-full border border-[#72bf78]/20 w-fit mb-4">
              {project.data.category}
            </span>
            <h2 class="text-white text-xl sm:text-2xl font-black uppercase tracking-tighter leading-tight mb-3 group-hover:text-[#72bf78] transition-colors italic">
              {project.data.title}
            </h2>
            <p class="text-white/60 text-xs sm:text-sm leading-relaxed mb-6 line-clamp-3 md:line-clamp-none">
              {project.data.description}
            </p>
            <a href={`/projects/${project.slug}/`} class="group/btn inline-flex items-center gap-4 text-white font-mono text-[10px] tracking-[0.3em] uppercase mt-auto">
              <span class="shrink-0">Ver Detalles</span>
              <div class="w-8 h-px bg-white/20 group-hover/btn:bg-[#72bf78] group-hover/btn:w-16 transition-all duration-500"></div>
            </a>
          </div>
        </article>
      ))}
    </div>
  </section>
</Layout>

<style>
  @reference "../../style/global.css";

  .filter-btn { 
    @apply px-5 py-2 rounded-full border border-white/10 text-white/40 font-mono text-[9px] sm:text-[10px] uppercase tracking-widest transition-all hover:text-white cursor-pointer; 
  }
  
  .filter-btn.active { 
    @apply border-[#72bf78] text-[#72bf78] bg-[#72bf78]/5; 
  }

  /* Ocultar scrollbar pero mantener funcionalidad */
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* Mejoras de legibilidad en pantallas muy pequeñas */
  @media (max-width: 400px) {
    h1 { font-size: 3.5rem; }
  }
</style>

<script>
  function setupFilters() {
    const buttons = document.querySelectorAll('.filter-btn') as NodeListOf<HTMLElement>;
    const items = document.querySelectorAll('.project-item') as NodeListOf<HTMLElement>;

    if (buttons.length === 0) return;

    function applyFilter(filterName: string) {
      buttons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filterName);
      });

      items.forEach(item => {
        const category = item.dataset.category;
        const shouldShow = filterName === 'all' || category === filterName;
        
        // Animación simple de entrada/salida
        if (shouldShow) {
          item.style.display = 'flex';
          setTimeout(() => item.style.opacity = '1', 10);
        } else {
          item.style.opacity = '0';
          item.style.display = 'none';
        }
      });
    }

    const params = new URLSearchParams(window.location.search);
    const initialFilter = params.get('filter') || 'all';
    applyFilter(initialFilter);

    buttons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const newFilter = btn.dataset.filter || 'all';
        applyFilter(newFilter);
        const newUrl = `${window.location.pathname}?filter=${newFilter}`;
        window.history.pushState({ path: newUrl }, '', newUrl);
      });
    });
  }

  setupFilters();
  document.addEventListener('astro:after-swap', setupFilters);
</script>