---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const allProjects = await getCollection("projects");
const sortedProjects = allProjects.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<Layout title="Portafolio | Proyectos">
  <section class="max-w-7xl mx-auto px-6 py-24 bg-[#0a0709]">
    
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-10 mb-20">
      <div>
        <h1 class="text-7xl font-black text-white uppercase italic tracking-tighter leading-none">Portfolio</h1>
        <p class="text-[#72bf78] font-mono text-sm tracking-[0.3em] uppercase mt-4">Proyectos & Aplicaciones</p>
      </div>

      <div class="flex gap-4">
        <button class="filter-btn active" data-filter="all">Todos</button>
        <button class="filter-btn" data-filter="página-web">Páginas Web</button>
        <button class="filter-btn" data-filter="aplicación-web">Apps Web</button>
        <button class="filter-btn" data-filter="soporte-página-web">Soporte Páginas Web</button>
      </div>
    </div>

    <div id="projectGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-10">
      {sortedProjects.map((project) => (
        <article 
          class="project-item group relative bg-[#0d0d0d] rounded-3xl border border-white/5 overflow-hidden flex flex-col md:flex-row transition-all hover:border-[#72bf78]/30 shadow-2xl"
          data-category={project.data.category.toLowerCase().replace(/\s+/g, '-')}
        >
          <div class="relative w-full md:w-[45%] aspect-video md:aspect-auto overflow-hidden shrink-0">
            <img 
              src={project.data.image} 
              alt={project.data.title} 
              class="w-full h-full object-cover grayscale opacity-40 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-700 group-hover:scale-110"
            />
            <div class="absolute inset-0 bg-linear-to-t md:bg-linear-to-r from-[#0d0d0d] via-transparent to-transparent"></div>
          </div>

          <div class="p-6 flex flex-col justify-center flex-1">
            <span class="text-[#72bf78] font-mono text-[10px] tracking-widest uppercase bg-[#72bf78]/10 px-3 py-1 rounded-full border border-[#72bf78]/20 w-fit mb-4">
              {project.data.category}
            </span>
            <h2 class="text-white text-2xl font-black uppercase tracking-tighter leading-tight mb-3 group-hover:text-[#72bf78] transition-colors italic">
              {project.data.title}
            </h2>
            <p class="text-white/60 text-sm leading-relaxed mb-3">{project.data.description}</p>
            <a href={`/projects/${project.slug}/`} class="group/btn inline-flex items-center gap-4 text-white font-mono text-[11px] tracking-[0.3em] uppercase mt-auto">
              <span>Ver Detalles</span>
              <div class="w-10 h-px bg-white/20 group-hover/btn:bg-[#72bf78] group-hover/btn:w-16 transition-all"></div>
            </a>
          </div>
        </article>
      ))}
    </div>
  </section>
</Layout>

<style>
  @reference "../../style/global.css";
  .filter-btn { @apply px-6 py-2 rounded-full border border-white/10 text-white/40 font-mono text-[10px] uppercase tracking-widest transition-all hover:text-white cursor-pointer; }
  .filter-btn.active { @apply border-[#72bf78] text-[#72bf78] bg-[#72bf78]/5; }
</style>

<script>
  function setupFilters() {
    // Definimos los tipos como NodeListOf<HTMLElement> para que TypeScript no se queje
    const buttons = document.querySelectorAll('.filter-btn') as NodeListOf<HTMLElement>;
    const items = document.querySelectorAll('.project-item') as NodeListOf<HTMLElement>;

    if (buttons.length === 0) return;

    function applyFilter(filterName: string) {
      // 1. Actualizar estado visual de los botones
      buttons.forEach(btn => {
        const isSelected = btn.dataset.filter === filterName;
        if (isSelected) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // 2. Filtrar los elementos del grid
      items.forEach(item => {
        const category = item.dataset.category;
        // Cambiamos el display. Si es 'all' o coincide, 'flex', si no, 'none'
        item.style.display = (filterName === 'all' || category === filterName) ? 'flex' : 'none';
      });
    }

    // --- LÓGICA DE INICIALIZACIÓN ---
    
    const params = new URLSearchParams(window.location.search);
    const initialFilter = params.get('filter') || 'all';
    
    // Aplicamos el filtro inicial
    applyFilter(initialFilter);

    // --- EVENTOS DE CLICK ---

    buttons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const newFilter = btn.dataset.filter || 'all';
        
        applyFilter(newFilter);
        
        // Actualizar la URL sin recargar
        const newUrl = `${window.location.pathname}?filter=${newFilter}`;
        window.history.pushState({ path: newUrl }, '', newUrl);
      });
    });
  }

  // Ejecución inicial
  setupFilters();

  // Reinicializar tras navegación de Astro (View Transitions)
  document.addEventListener('astro:after-swap', setupFilters);
</script>