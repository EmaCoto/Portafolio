---
import { getCollection } from "astro:content";
import TitleSecundary from "./TitleSecundary.astro";

const rawProjects = await getCollection("projects");

const projects = rawProjects
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .map(project => ({
    title: project.data.title,
    category: project.data.category,
    image: typeof project.data.image === 'string' ? project.data.image : (project.data.image as any)?.src,
    slug: project.slug
  }));
---

<div class="w-full overflow-hidden">
  <section id="projects-section" class="relative flex flex-col justify-center py-2 md:py-4">
    <TitleSecundary h2="Proyectos" span="Trabajos Destacados" />

    <div class="projects-container relative flex items-center mt-4">
      <div class="projects-wrapper flex gap-4 md:gap-10 px-[5vw] md:px-[10vw]">
        {projects.map((project) => (
          <div class="flex flex-col">
            <a 
              href={`/projects/${project.slug}`}
              class="project-card group relative min-w-[85vw] sm:min-w-[50vw] md:min-w-[45vw] lg:min-w-[35vw] h-[40vh] md:h-[55vh] block overflow-hidden"
            >
              <img 
                src={project.image} 
                aria-hidden="true"
                class="absolute inset-0 w-full h-full object-cover blur-3xl opacity-30 scale-110 z-0"
              />

              <div class="absolute inset-0 z-20 via-transparent to-transparent opacity-80 transition-opacity"></div>

              <img 
                src={project.image} 
                alt={project.title} 
                class="project-img relative z-10 w-full h-full object-contain 
                       /* MÓVIL: Siempre color y tamaño completo */
                       opacity-100 grayscale-0 scale-100
                       /* PC: Inicia opaca, gris y pequeña; agranda en hover */
                       md:opacity-60 md:grayscale md:scale-90 
                       md:group-hover:grayscale-0 md:group-hover:opacity-100 md:group-hover:scale-105
                       transition-all duration-700 ease-out"
              />

              <div class="absolute bottom-0 left-0 p-5 z-30 transition-transform duration-500 md:group-hover:-translate-y-2">
                <p class="text-[#72bf78] font-mono text-[10px] mb-1 tracking-[0.2em] uppercase">{project.category}</p>
                <h3 class="text-white text-xl md:text-2xl font-black uppercase tracking-tighter leading-tight italic">
                  {project.title}
                </h3>
              </div>
            </a>
          </div>
        ))}
      </div>
    </div>
  </section>
</div>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const initProjects = () => {
    const section = document.querySelector("#projects-section");
    const wrapper = document.querySelector(".projects-wrapper") as HTMLElement;

    if (!section || !wrapper) return;

    ScrollTrigger.getAll().filter(st => st.trigger === section).forEach(st => st.kill());

    gsap.to(wrapper, {
      x: () => -(wrapper.scrollWidth - window.innerWidth + window.innerWidth * 0.05),
      ease: "none",
      scrollTrigger: {
        trigger: section,
        pin: true,
        scrub: 1,
        start: "top 10%",
        end: () => "+=" + wrapper.scrollWidth,
        invalidateOnRefresh: true,
      }
    });
  };

  initProjects();
  document.addEventListener("astro:after-swap", initProjects);
</script>

<style>
  #projects-section { will-change: transform; }
  /* Asegura que el zoom no se salga de la "caja" invisible */
  .project-card { backface-visibility: hidden; }
</style>