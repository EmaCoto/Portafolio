---
import { getCollection } from "astro:content";
import TitleSecundary from "./TitleSecundary.astro";

// Obtenemos todos los proyectos de la colección 'projects'
const rawProjects = await getCollection("projects");

// Ordenamos por fecha y los preparamos para el diseño
const projects = rawProjects
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .map(project => ({
    title: project.data.title,
    category: project.data.category,
    // Usamos la misma lógica que en el blog para evitar errores de TypeScript
    image: typeof project.data.image === 'string' ? project.data.image : (project.data.image as any)?.src,
    slug: project.slug
  }));
---

<div class="w-full overflow-hidden">
  <section id="projects-section" class="relative min-h-[90vh] flex flex-col justify-center py-5 md:py-20">
    <TitleSecundary h2="Proyectos" span="Trabajos Destacados" />

    <div class="projects-container relative  flex items-center">
      <div class="projects-wrapper flex gap-6 md:gap-12 px-[5vw] md:px-[10vw]">
        {projects.map((project, index) => (
          <div class="flex flex-col gap-x-4">
            {/* <span class="text-[#72bf78] font-mono text-xs opacity-50">0{index + 1}</span> */}
            
            <a 
              href={`/projects/${project.slug}`}
              class="project-card group relative min-w-[80vw] sm:min-w-[50vw] md:min-w-[45vw] lg:min-w-[35vw] h-[45vh] md:h-[55vh] overflow-hidden rounded-xl  block"
            >
              <div class="absolute inset-0 z-20 bg-linear-to-t from-[#0a0709] via-transparent to-transparent opacity-90 group-hover:opacity-70 transition-opacity"></div>

              <img 
                src={project.image} 
                alt={project.title} 
                class="project-img absolute inset-0 w-full h-full object-cover scale-110 transition-transform duration-1000 group-hover:scale-100 opacity-50 group-hover:opacity-100 grayscale group-hover:grayscale-0"
              />

              <div class="absolute bottom-0 left-0 p-6 md:p-8 z-30 transition-transform duration-500 group-hover:-translate-y-2">
                <p class="text-[#72bf78] font-mono text-[10px] md:text-xs mb-1 tracking-[0.2em] uppercase">{project.category}</p>
                <h3 class="text-white text-xl md:text-2xl font-black uppercase tracking-tighter leading-tight italic">
                  {project.title}
                </h3>
              </div>
            </a>
          </div>
        ))}
      </div>
    </div>
  </section>
</div>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const initProjects = () => {
    const section = document.querySelector("#projects-section");
    const wrapper = document.querySelector(".projects-wrapper") as HTMLElement;

    if (!section || !wrapper) return;

    // Matamos cualquier instancia previa para evitar errores en navegación Astro (View Transitions)
    ScrollTrigger.getAll().filter(st => st.trigger === section).forEach(st => st.kill());

    // Animación horizontal
    gsap.to(wrapper, {
      x: () => -(wrapper.scrollWidth - window.innerWidth + window.innerWidth * 0.05),
      ease: "none",
      scrollTrigger: {
        trigger: section,
        pin: true,
        scrub: 1,
        start: "top top", 
        end: () => "+=" + wrapper.scrollWidth,
        invalidateOnRefresh: true,
      }
    });

    // Tilt suave
    const cards = document.querySelectorAll(".project-card");
    cards.forEach(card => {
      card.addEventListener("mousemove", (e: any) => {
        const rect = card.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width - 0.5;
        const y = (e.clientY - rect.top) / rect.height - 0.5;

        gsap.to(card, {
          rotationY: x * 5,
          rotationX: -y * 5,
          duration: 0.5,
          ease: "power2.out"
        });
      });

      card.addEventListener("mouseleave", () => {
        gsap.to(card, { rotationY: 0, rotationX: 0, duration: 0.5 });
      });
    });
  };

  // Ejecutar al cargar y tras cambios de página
  initProjects();
  document.addEventListener("astro:after-swap", initProjects);
</script>

<style>
  #projects-section { will-change: transform; }
  .project-card { transform-style: preserve-3d; perspective: 1000px; }
</style>